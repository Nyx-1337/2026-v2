<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ƒê·∫øm ng∆∞·ª£c ƒë·∫øn T·∫øt Nguy√™n ƒê√°n 2026 üéÜ</title>
<style>
#calendarPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 400px;
  height: 440px;
  padding: 20px;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  color: #ffd700;
  display: none;
  z-index: 200;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 215, 0, 0.2);
  overflow-y: auto;
}

.calendarGrid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-top: 10px;
}

.calendarGrid div {
  text-align: center;
  padding: 8px 4px;
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.08);
  font-size: 0.85em;
  color: #ffd700;
  min-height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.calendarGrid .empty {
  background: transparent;
}

.calendarGrid .important {
  background: rgba(255, 100, 100, 0.6);
  color: #fff;
  font-weight: bold;
  border: 1px solid #ff6666;
}

.calendarGrid .today {
  background: rgba(100, 200, 255, 0.5);
  color: #fff;
  border: 1px solid #66ccff;
}

:root{--bg:#05030a;--panel:rgba(255,255,255,0.06);}
*{box-sizing:border-box;margin:0;padding:0;}
body {
  height:100vh;
  overflow:hidden;
  background: url('background-tet-2023-20-1.jpg') no-repeat center center / cover;
  font-family: 'Segoe UI', sans-serif;
}

@keyframes shake{0%,100%{transform:translate(0);}20%{transform:translate(-1px,1px);}
40%{transform:translate(1px,-1px);}60%{transform:translate(-1px,0.5px);}
80%{transform:translate(1px,-0.5px);}}
.shake{animation:shake 0.2s linear;}

header {
    position: fixed; 
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
}
header .panel {
    background-color: rgba(0, 0, 0, 0.6);
    padding: 15px 25px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
.countdown {
    font-size: 2.5em;
    font-weight: 700;
    color: #ffcc00;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}
.sub {
    font-size: 1.1em;
    color: #ffd700;
}

#nowTime { margin-top: 4px; }

#overlayText {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 90;
    text-align: center;
    color: #ff4da6; 
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    display: none;
}
#overlayText h1 { font-size: 3em; }

#controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 100;
    display: flex;
    gap: 10px;
}
.btn {
    padding: 10px 15px;
    cursor: pointer;
    border-radius: 8px;
    background-color: rgba(255, 255, 255, 0.2);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.4);
    transition: 0.2s;
}
.btn:hover { background-color: rgba(255, 255, 255, 0.4); }

#c { position: fixed; top: 0; left: 0; z-index: 1; }

#eventsBox {
  position: fixed;
  top: 140px;
  left: 20px;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 10px;
  transition: 0.3s ease;
}

#eventsBox.hidden {
  display: none;
}

#toggleEventsBtn {
  position: fixed;
  top: 140px;
  left: 20px;
  z-index: 101;
  padding: 8px 12px;
  background-color: rgba(255, 215, 0, 0.7);
  color: #000;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
  font-size: 1em;
  display: none;
}

#toggleEventsBtn:hover {
  background-color: #ffd700;
}

.eventItem {
  background: rgba(0,0,0,0.55);
  color: #ffd700;
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 1.1em;
  box-shadow: 0 4px 8px rgba(0,0,0,0.35);
}

@media (max-width: 768px) {
  #eventsBox {
    display: none !important;
  }
  
  #toggleEventsBtn {
    display: block !important;
  }
  
  #musicControls {
    width: calc(100% - 30px);
    left: 15px;
    bottom: 10px;
  }
  
  #controls {
    bottom: 10px;
    right: 10px;
    flex-direction: column;
    gap: 8px;
  }
  
  .btn {
    padding: 8px 12px;
    font-size: 0.9em;
  }
  
  header .panel {
    width: 90vw;
    max-width: 500px;
    padding: 10px 15px;
  }
  
  .countdown {
    font-size: 1.8em;
  }
  
  .sub {
    font-size: 0.9em;
  }
}
#musicControls {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 999;
  width: 280px;
  padding: 15px;
  background: rgba(0,0,0,0.7);
  border-radius: 12px;
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,215,0,0.3);
}

#bgVideo {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  z-index: 0;
  pointer-events: none;
  filter: brightness(0.95);
}

.drag-handle {
  height: 14px;
  width: 100%;
  cursor: move;
  border-radius: 8px;
  margin-bottom: 8px;
  touch-action: none;
  background: rgba(255,255,255,0.02);
}

#musicControls button {
  padding: 8px 12px;
  background: #ffd700;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.2s;
}

#musicControls button:hover {
  background: #ffed4e;
  transform: scale(1.05);
}

#musicControls input[type=range] {
  cursor: pointer;
  accent-color: #ffd700;
}
</style>
</head>
<body>
<video id="bgVideo" autoplay muted loop playsinline>
  <source src="Ngua.mp4" type="video/mp4">
</video>
<header>
  <div class="panel">
    <div class="countdown" id="countdown">ƒêang t·∫£i...</div>
    <div class="sub" id="nowTime">Th·ªùi gian hi·ªán t·∫°i: --:--:--</div>
    <div class="sub">
      ƒê·∫øm ng∆∞·ª£c ƒë·∫øn <strong>M√πng 1 T·∫øt √Çm L·ªãch 2026 ‚Äî 17/02/2026</strong>
    </div>
  </div>
</header>
<div id="calendarPanel">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <button id="prevMonthBtn" style="background: #ffd700; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-weight: bold;">‚óÑ</button>
    <h3 style="margin: 0; color: #ffd700; font-size: 1.1em;" id="calendarTitle">Th√°ng 1/2026</h3>
    <button id="nextMonthBtn" style="background: #ffd700; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-weight: bold;">‚ñ∫</button>
  </div>
  <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 0.85em;">
    <div style="color: #ffaa00; font-weight: bold; padding: 6px 0;">T2</div>
    <div style="color: #ffaa00; font-weight: bold; padding: 6px 0;">T3</div>
    <div style="color: #ffaa00; font-weight: bold; padding: 6px 0;">T4</div>
    <div style="color: #ffaa00; font-weight: bold; padding: 6px 0;">T5</div>
    <div style="color: #ffaa00; font-weight: bold; padding: 6px 0;">T6</div>
    <div style="color: #ff6666; font-weight: bold; padding: 6px 0;">T7</div>
    <div style="color: #ff6666; font-weight: bold; padding: 6px 0;">CN</div>
    <div id="calendarGrid" style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;"></div>
  </div>
</div>

<div class="btn" id="toggleCalendar" style="bottom:80px; right:20px; position:fixed; z-index:100;">
  L·ªãch
</div>
<div id="overlayText"></div>

<button id="toggleEventsBtn">üìã S·ª± ki·ªán</button>

<div id="eventsBox">
  <div class="drag-handle" style="height:14px;width:100%;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);"></div>
  <div class="eventItem" id="eventTaoQuan">üßß √îng C√¥ng √îng T√°o: -- ng√†y</div>
  <div class="eventItem" id="eventLastWork">üìå Ng√†y h·ªçc nƒÉm 2025(√¢m): -- ng√†y</div>
  <div class="eventItem" id="eventHoliday">üéâ Ngh·ªâ T·∫øt ch√≠nh th·ª©c: -- ng√†y</div>
</div>

<div id="controls">
  <div class="drag-handle" style="height:14px;width:100%;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);"></div>
  <div class="btn" id="toggleAuto">Ph√°o Hoa: B·∫≠t</div>
  <div class="btn" id="clearAll">L√†m m·ªõi</div>
</div>

<audio id="backgroundMusic">
  <source src="" type="audio/mpeg">
</audio>

<div id="musicControls">
  <div class="drag-handle" style="height:14px;width:100%;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);"></div>
  <div style="margin-bottom: 10px; color: #ffd700; font-size: 0.9em;" id="currentTrack">B√†i h√°t: Ch∆∞a ch·ªçn</div>
  <select id="playlistSelect" style="padding: 6px; border-radius: 6px; width: 100%; margin-bottom: 8px; background: rgba(0,0,0,0.6); color: #ffd700; border: 1px solid #ffd700;">
    <option value="">-- Ch·ªçn b√†i h√°t --</option>
    <option value="Kh√¥ng Ph·∫£i Nh·∫°c T·∫øt - Speed 1.3 - ƒê·∫∑ng Tu·∫•n V≈©.mp3">Kh√¥ng Ph·∫£i Nh·∫°c T·∫øt - Speed 1.3 - ƒê·∫∑ng Tu·∫•n V≈©</option>
    <option value="M·ªôt NƒÉm M·ªõi B√¨nh An - S∆°n T√πng M-TP.mp3">M·ªôt NƒÉm M·ªõi B√¨nh An - S∆°n T√πng M-TP</option>
    <option value="NƒÉm Qua ƒê√£ L√†m G√¨ - Noo Ph∆∞·ªõc Th·ªãnh.mp3">NƒÉm Qua ƒê√£ L√†m G√¨ - Noo Ph∆∞·ªõc Th·ªãnh</option>
    <option value="T·∫øt ƒêong ƒê·∫ßy - KHOA.mp3">T·∫øt ƒêong ƒê·∫ßy - KHOA</option>
    <option value="T·∫øt L√† T·∫øt Sum V·∫ßy (Remix) - Orinn.mp3">T·∫øt L√† T·∫øt Sum V·∫ßy (Remix) - Orinn</option>
    <option value="T·∫øt N√†y Con S·∫Ω V·ªÅ - B√πi C√¥ng Nam.mp3">T·∫øt N√†y Con S·∫Ω V·ªÅ - B√πi C√¥ng Nam</option>
  </select>
  <div style="display: flex; gap: 8px; margin-bottom: 8px;">
    <button id="prevBtn" style="flex: 1; padding: 8px; background: #ffd700; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚èÆ Tr∆∞·ªõc</button>
    <button id="playMusicBtn" style="flex: 1; padding: 8px; background: #ffd700; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚ñ∂ Ph√°t</button>
    <button id="nextBtn" style="flex: 1; padding: 8px; background: #ffd700; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">‚è≠ Sau</button>
  </div>
  <div style="display: flex; gap: 8px;">
    <button id="shuffleBtn" style="flex: 1; padding: 8px; background: rgba(255,215,0,0.5); border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üîÄ Tr·ªôn</button>
    <button id="repeatBtn" style="flex: 1; padding: 8px; background: rgba(255,215,0,0.5); border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üîÅ L·∫∑p</button>
  </div>
  <div style="margin-top: 8px;">
    <button id="syncFireworksBtn" style="width: 100%; padding: 8px; background: rgba(255,215,0,0.5); border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #000;">üéÜ ƒê·ªìng b·ªô Ph√°o</button>
  </div>
  <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
    <label for="volumeControl" style="color: #ffd700;">üîä</label>
    <input type="range" id="volumeControl" min="0" max="100" value="50" style="flex: 1; cursor: pointer;">
  </div>
</div>

<canvas id="c"></canvas>

<script>
const target=new Date('2026-02-17T00:00:00');
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
let W=canvas.width=innerWidth,H=canvas.height=innerHeight;
onresize=()=>{W=canvas.width=innerWidth;H=canvas.height=innerHeight;};

const cdEl=document.getElementById('countdown');
const overlay=document.getElementById('overlayText');
let newYearTriggered=false;

let currentCalendarMonth = 1;
let currentCalendarYear = 2026;
const importantDates = [
  { month: 2, day: 10 },
  { month: 2, day: 14 },
  { month: 2, day: 16 },
  { month: 2, day: 17 },
  { month: 2, day: 18 },
  { month: 2, day: 19 },
  { month: 2, day: 20 },
  { month: 2, day: 21 }
];

function generateCalendar() {
  const calendarGrid = document.getElementById('calendarGrid');
  const calendarTitle = document.getElementById('calendarTitle');
  
  calendarGrid.innerHTML = '';
  calendarTitle.textContent = currentCalendarMonth === 1 ? 'Th√°ng 1/2026' : 'Th√°ng 2/2026';
  
  const firstDay = new Date(currentCalendarYear, currentCalendarMonth - 1, 1).getDay();
  const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth, 0).getDate();
  

  for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'empty';
    calendarGrid.appendChild(emptyCell);
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dayCell = document.createElement('div');
    dayCell.textContent = day;
    
    const isImportant = importantDates.some(d => d.month === currentCalendarMonth && d.day === day);
    if (isImportant) {
      dayCell.className = 'important';
    } else {
      dayCell.className = '';
    }
    
    calendarGrid.appendChild(dayCell);
  }
}

document.getElementById('prevMonthBtn').onclick = () => {
  if (currentCalendarMonth > 1) {
    currentCalendarMonth--;
    generateCalendar();
  }
};

document.getElementById('nextMonthBtn').onclick = () => {
  if (currentCalendarMonth < 2) {
    currentCalendarMonth++;
    generateCalendar();
  }
};

generateCalendar();

document.getElementById('toggleCalendar').onclick = () => {
  const calendarPanel = document.getElementById('calendarPanel');
  calendarPanel.style.display = calendarPanel.style.display === 'none' ? 'block' : 'none';
};

function rand(a,b){return Math.random()*(b-a)+a;}
function choice(a){return a[Math.floor(Math.random()*a.length)];}
function hexToRgba(hex,a){
 let n=parseInt(hex.slice(1),16);
 return`rgba(${(n>>16)&255},${(n>>8)&255},${n&255},${a})`;
}

function updateCountdown(){
  const now=new Date();
  let diff=target-now;

  if(diff<=0 && !newYearTriggered){
    newYearTriggered=true;
    overlay.style.display="block";
    overlay.innerHTML=`
      <h1>üéÜ Ch√∫c m·ª´ng NƒÉm M·ªõi 2026 ‚Äî B√≠nh Ng·ªç üéÜ</h1>
      <p>Ch√∫c b·∫°n m·ªôt nƒÉm m·ªõi an khang, th·ªãnh v∆∞·ª£ng!</p>
    `;

    intensity = 5;
    auto = true;

    for(let i=0;i<15;i++) setTimeout(()=>{
      const x=rand(W*0.25,W*0.75);
      for(let j=0;j<3;j++) launchRocket(x+rand(-60,60));
    },i*400);
  }

  if(diff<=0){
    cdEl.textContent="üéâ ƒê√É ƒê·∫æN T·∫æT √ÇM L·ªäCH 2026 üéâ";
    return;
  }

  const d=Math.floor(diff/86400000);
  diff%=86400000;
  const h=Math.floor(diff/3600000);
  diff%=3600000;
  const m=Math.floor(diff/60000);
  diff%=60000;
  const s=Math.floor(diff/1000);

  cdEl.innerHTML=
    `${d} ng√†y ${String(h).padStart(2,'0')}:`
  + `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
setInterval(updateCountdown,250);
updateCountdown();

function updateNowTime(){
  const now=new Date();
  const hh=String(now.getHours()).padStart(2,'0');
  const mm=String(now.getMinutes()).padStart(2,'0');
  const ss=String(now.getSeconds()).padStart(2,'0');
  document.getElementById("nowTime").textContent =
    `Th·ªùi gian hi·ªán t·∫°i: ${hh}:${mm}:${ss}`;
}
setInterval(updateNowTime,1000);
updateNowTime();

function updateEvents(){
  const now = new Date();

  const taoQuan = new Date("2026-02-10T00:00:00");
  const lastWork = new Date("2026-02-14T00:00:00");
  const holiday = new Date("2026-02-16T00:00:00");

  const dTao = Math.floor((taoQuan - now) / 86400000);
  const dLast = Math.floor((lastWork - now) / 86400000);
  const dHoliday = Math.floor((holiday - now) / 86400000);

  document.getElementById("eventTaoQuan").textContent =
    `üßß √îng C√¥ng √îng T√°o: ${dTao >= 0 ? dTao + " ng√†y" : "ƒê√£ qua"}`;

  document.getElementById("eventLastWork").textContent =
    `üìå Ng√†y h·ªçc cu·ªëi c√πng nƒÉm 2025(√¢m): ${dLast >= 0 ? dLast + " ng√†y" : "ƒê√£ qua"}`;

  document.getElementById("eventHoliday").textContent =
    `üéâ Ngh·ªâ T·∫øt ch√≠nh th·ª©c: ${dHoliday >= 0 ? dHoliday + " ng√†y" : "ƒê√£ b·∫Øt ƒë·∫ßu"}`;
}
setInterval(updateEvents,1000);
updateEvents();

const rockets=[],particles=[];
const palettes=[
 ['#ff3b30','#ff7a59','#ffd88a'],
 ['#ff4da6','#ff77c7','#ffd1e8'],
 ['#ffd700','#ffac33','#fff5cc'],
 ['#5be7ff','#66d6ff','#bfefff']
];

let auto=true,intensity=5;
const MAX_PARTICLES=1500;

class Rocket{
 constructor(x,y,vx,vy){
  this.x=x;this.y=y;this.vx=vx;this.vy=vy;
  this.age=0;this.trail=[];this.ttl=rand(60,100);
 }
 update(){
  this.age++;
  this.trail.push({x:this.x,y:this.y});
  if(this.trail.length>10) this.trail.shift();
  this.vy+=0.08;this.x+=this.vx;this.y+=this.vy;
  if(this.vy>0 || this.age>this.ttl){
    explode(this.x,this.y);return false;
  }
  return true;
 }
 draw(){
  ctx.beginPath();
  ctx.arc(this.x,this.y,2.5,0,Math.PI*2);
  ctx.fillStyle='#fff';
  ctx.fill();
 }
}

class Particle{
 constructor(x,y,vx,vy,life,color,size){
  this.x=x;this.y=y;this.vx=vx;this.vy=vy;
  this.life=life;this.maxLife=life;
  this.color=color;this.size=size;
 }
 update(){
  this.vy+=0.06;this.x+=this.vx;this.y+=this.vy;
  this.life--;
  return this.life>0 && this.y<H+50;
 }
 draw(){
  const t=this.life/this.maxLife;
  ctx.beginPath();
  ctx.arc(this.x,this.y,this.size*t,0,Math.PI*2);
  ctx.fillStyle=hexToRgba(this.color,t);
  ctx.fill();
 }
}

function safePush(p){
  if(particles.length<MAX_PARTICLES) particles.push(p);
}

function explode(x,y){
  const pal=choice(palettes);
  const count=Math.floor(rand(intensity*12,intensity*20));
  for(let i=0;i<count;i++){
    const a=rand(0,Math.PI*2),s=rand(1.5,5.5);
    safePush(new Particle(
      x,y,Math.cos(a)*s,Math.sin(a)*s,
      rand(40,100), choice(pal),
      rand(1.8,4.5)
    ));
  }
}

function launchRocket(x){
  const sx=rand(W*0.2,W*0.8);
  const vx=(x-sx)*0.005+rand(-0.4,0.4);
  const vy=rand(-6.6,-9.5);
  rockets.push(new Rocket(sx,H,vx,vy));
}

let drawing=false,drawPoints=[];

canvas.addEventListener("mousedown",e=>{
 drawing=true;createClickEffect(e.clientX,e.clientY);shakeScreen();
});
canvas.addEventListener("mouseup",()=>{drawing=false;drawPoints=[];});
canvas.addEventListener("mousemove",e=>{
 if(drawing){
   drawPoints.push({x:e.clientX,y:e.clientY,life:30});
   createClickEffect(e.clientX,e.clientY);
   if(Math.random()<0.2) shakeScreen();
 }
});

function createClickEffect(x,y){
 for(let i=0;i<20;i++){
  const a=rand(0,Math.PI*2),s=rand(1,4);
  const color=choice(["#ffdd55","#ffaa44","#ff66aa","#66ccff"]);
  safePush(new Particle(
    x,y,Math.cos(a)*s,Math.sin(a)*s,
    rand(30,60), color,
    rand(1.5,3)
  ));
 }
}

function drawMouseTrail(){
 for(let i=drawPoints.length-1;i>=0;i--){
  const p=drawPoints[i];
  ctx.beginPath();
  ctx.arc(p.x,p.y,3,0,Math.PI*2);
  ctx.fillStyle=`rgba(255,255,200,${p.life/30})`;
  ctx.fill();
  p.life--;
  if(p.life<=0) drawPoints.splice(i,1);
 }
}

function shakeScreen(){
  document.body.classList.add('shake');
  setTimeout(()=>document.body.classList.remove('shake'),200);
}

function loop(){
 // Fade previous frame by gently erasing a tiny fraction so darkening does not accumulate
 ctx.globalCompositeOperation = 'destination-out';
 ctx.fillStyle = 'rgba(0,0,0,0.02)';
 ctx.fillRect(0,0,W,H);
 // Use additive blending for fireworks/particles so they brighten the scene
 ctx.globalCompositeOperation = 'lighter';

 drawMouseTrail();

 if(auto && Math.random()<0.025*intensity){
   const x=rand(W*0.2,W*0.8);
   launchRocket(x);
   if(Math.random()<0.4) launchRocket(x+rand(-100,100));
 }

 for(let i=rockets.length-1;i>=0;i--){
   if(!rockets[i].update()) rockets.splice(i,1);
   else rockets[i].draw();
 }
 for(let i=particles.length-1;i>=0;i--){
   if(!particles[i].update()) particles.splice(i,1);
   else particles[i].draw();
 }

 requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

document.getElementById('toggleAuto').onclick=()=>{
 auto=!auto;
 document.getElementById('toggleAuto').textContent=
   'Ph√°o Hoa: ' + (auto?'B·∫≠t':'T·∫Øt');
};

document.getElementById('clearAll').onclick=()=>{
 rockets.length=0;particles.length=0;drawPoints.length=0;
};

const toggleEventsBtn = document.getElementById('toggleEventsBtn');
const eventsBox = document.getElementById('eventsBox');

toggleEventsBtn.onclick = () => {
  eventsBox.classList.toggle('hidden');
  toggleEventsBtn.textContent = eventsBox.classList.contains('hidden') ? 'üìã Hi·ªán' : 'üìã ·∫®n';
};

window.addEventListener('resize', () => {
  if (window.innerWidth > 768) {
    eventsBox.classList.remove('hidden');
    toggleEventsBtn.style.display = 'none';
  } else {
    if (!eventsBox.classList.contains('hidden')) {
      toggleEventsBtn.style.display = 'block';
    }
  }
});

if (window.innerWidth <= 768) {
  toggleEventsBtn.style.display = 'block';
}

function makeDraggable(element) {
  if (!element) return;
  
  let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  let dragging = false;
  
  element.addEventListener('mousedown', dragMouseDown);
  element.addEventListener('touchstart', dragMouseDown, { passive: false });
  
  function dragMouseDown(e) {
    e = e || window.event;
    const target = e.target || e.srcElement;
    // Only start dragging when user presses the drag-handle inside the element
    if (!target.classList || !target.classList.contains('drag-handle')) return;
    e.preventDefault();
    dragging = true;
    pos3 = e.clientX || e.touches[0].clientX;
    pos4 = e.clientY || e.touches[0].clientY;
    
    document.addEventListener('mouseup', closeDragElement);
    document.addEventListener('touchend', closeDragElement);
    document.addEventListener('mousemove', elementDrag);
    document.addEventListener('touchmove', elementDrag, { passive: false });
  }
  
  function elementDrag(e) {
    if (!dragging) return;
    e = e || window.event;
    e.preventDefault();
    pos1 = pos3 - (e.clientX || e.touches[0].clientX);
    pos2 = pos4 - (e.clientY || e.touches[0].clientY);
    pos3 = e.clientX || e.touches[0].clientX;
    pos4 = e.clientY || e.touches[0].clientY;
    
    element.style.top = (element.offsetTop - pos2) + "px";
    element.style.left = (element.offsetLeft - pos1) + "px";
  }
  
  function closeDragElement() {
    dragging = false;
    document.removeEventListener('mouseup', closeDragElement);
    document.removeEventListener('touchend', closeDragElement);
    document.removeEventListener('mousemove', elementDrag);
    document.removeEventListener('touchmove', elementDrag);
  }
}
makeDraggable(document.getElementById('eventsBox'));
makeDraggable(document.getElementById('controls'));
makeDraggable(document.getElementById('musicControls'));

document.querySelectorAll('.drag-handle').forEach(el => { if (el) el.style.cursor = 'move'; });
const eventsBoxEl = document.getElementById('eventsBox');
const controlsEl = document.getElementById('controls');
const musicControlsEl = document.getElementById('musicControls');

if (eventsBoxEl) { makeDraggable(eventsBoxEl); }
if (controlsEl) { makeDraggable(controlsEl); }
if (musicControlsEl) { makeDraggable(musicControlsEl); }

const audio = document.getElementById('backgroundMusic');
const playBtn = document.getElementById('playMusicBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const playlistSelect = document.getElementById('playlistSelect');
const volumeControl = document.getElementById('volumeControl');
const currentTrackDisplay = document.getElementById('currentTrack');

const playlist = [
  'Kh√¥ng Ph·∫£i Nh·∫°c T·∫øt - Speed 1.3 - ƒê·∫∑ng Tu·∫•n V≈©.mp3',
  'M·ªôt NƒÉm M·ªõi B√¨nh An - S∆°n T√πng M-TP.mp3',
  'NƒÉm Qua ƒê√£ L√†m G√¨ - Noo Ph∆∞·ªõc Th·ªãnh.mp3',
  'T·∫øt ƒêong ƒê·∫ßy - KHOA.mp3',
  'T·∫øt L√† T·∫øt Sum V·∫ßy (Remix) - Orinn.mp3',
  'T·∫øt N√†y Con S·∫Ω V·ªÅ - B√πi C√¥ng Nam.mp3'
];

const playlistNames = [
  'Kh√¥ng Ph·∫£i Nh·∫°c T·∫øt - Speed 1.3 - ƒê·∫∑ng Tu·∫•n V≈©',
  'M·ªôt NƒÉm M·ªõi B√¨nh An - S∆°n T√πng M-TP',
  'NƒÉm Qua ƒê√£ L√†m G√¨ - Noo Ph∆∞·ªõc Th·ªãnh',
  'T·∫øt ƒêong ƒê·∫ßy - KHOA',
  'T·∫øt L√† T·∫øt Sum V·∫ßy (Remix) - Orinn',
  'T·∫øt N√†y Con S·∫Ω V·ªÅ - B√πi C√¥ng Nam'
];

let currentIndex = -1;
let isShuffle = false;
let repeatMode = 0; 

function loadTrack(index) {
  if (index >= 0 && index < playlist.length) {
    currentIndex = index;
    audio.src = playlist[index];
    currentTrackDisplay.textContent = 'üéµ ' + playlistNames[index];
    playlistSelect.value = playlist[index];
    playBtn.textContent = '‚è∏ D·ª´ng';
    audio.play();
  }
}

playlistSelect.onchange = (e) => {
  const idx = playlist.indexOf(e.target.value);
  if (idx >= 0) {
    loadTrack(idx);
  }
};

playBtn.onclick = () => {
  if (audio.src === '') {
    alert('Vui l√≤ng ch·ªçn b√†i h√°t');
    return;
  }
  if (audio.paused) {
    audio.play();
    playBtn.textContent = '‚è∏ D·ª´ng';
  } else {
    audio.pause();
    playBtn.textContent = '‚ñ∂ Ph√°t';
  }
};

prevBtn.onclick = () => {
  if (currentIndex > 0) {
    loadTrack(currentIndex - 1);
  }
};

nextBtn.onclick = () => {
  if (currentIndex < playlist.length - 1) {
    loadTrack(currentIndex + 1);
  } else if (repeatMode === 1) {
    loadTrack(0);
  }
};

shuffleBtn.onclick = () => {
  isShuffle = !isShuffle;
  shuffleBtn.style.background = isShuffle ? '#ffaa00' : 'rgba(255,215,0,0.5)';
  shuffleBtn.style.opacity = isShuffle ? '1' : '0.7';
};

repeatBtn.onclick = () => {
  repeatMode = (repeatMode + 1) % 3;
  if (repeatMode === 0) {
    repeatBtn.textContent = 'üîÅ L·∫∑p';
    repeatBtn.style.background = 'rgba(255,215,0,0.5)';
  } else if (repeatMode === 1) {
    repeatBtn.textContent = 'üîÅ L·∫∑p T·∫•t';
    repeatBtn.style.background = '#ffaa00';
  } else {
    repeatBtn.textContent = 'üîÅ L·∫∑p 1';
    repeatBtn.style.background = '#ff6600';
  }
};

audio.onended = () => {
  if (repeatMode === 2) {
    audio.currentTime = 0;
    audio.play();
  } else if (isShuffle) {
    const randomIndex = Math.floor(Math.random() * playlist.length);
    loadTrack(randomIndex);
  } else if (currentIndex < playlist.length - 1) {
    loadTrack(currentIndex + 1);
  } else if (repeatMode === 1) {
    loadTrack(0);
  } else {
    playBtn.textContent = '‚ñ∂ Ph√°t';
  }
};

volumeControl.oninput = (e) => {
  audio.volume = e.target.value / 100;
};


let audioContext;
let analyser;
let dataArray;
let syncFireworksEnabled = false;
const syncFireworksBtn = document.getElementById('syncFireworksBtn');

function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    const source = audioContext.createMediaElementAudioSource(audio);
    source.connect(analyser);
    analyser.connect(audioContext.destination);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
}

syncFireworksBtn.onclick = () => {
  if (!audio.src) {
    alert('Vui l√≤ng ch·ªçn b√†i h√°t tr∆∞·ªõc');
    return;
  }
  
  syncFireworksEnabled = !syncFireworksEnabled;
  
  if (syncFireworksEnabled) {
    initAudioContext();
    syncFireworksBtn.style.background = '#ff6600';
    syncFireworksBtn.style.color = '#fff';
    syncFireworksBtn.textContent = 'üéÜ ƒê·ªìng b·ªô: B·∫¨T';
  } else {
    syncFireworksBtn.style.background = 'rgba(255,215,0,0.5)';
    syncFireworksBtn.style.color = '#000';
    syncFireworksBtn.textContent = 'üéÜ ƒê·ªìng b·ªô Ph√°o';
  }
};

let lastBeatTime = 0;
const BEAT_THRESHOLD = 150;
const BEAT_COOLDOWN = 300;

function detectBeatAndFireworks() {
  if (!syncFireworksEnabled || !analyser) return;
  
  analyser.getByteFrequencyData(dataArray);
  
  let basEnergy = 0;
  for (let i = 0; i < 10; i++) {
    basEnergy += dataArray[i];
  }
  
  const currentTime = Date.now();
  
  if (basEnergy > BEAT_THRESHOLD && (currentTime - lastBeatTime) > BEAT_COOLDOWN) {
    lastBeatTime = currentTime;
    

    const rocketCount = Math.floor(Math.random() * 2) + 2;
    for (let i = 0; i < rocketCount; i++) {
      setTimeout(() => {
        const x = rand(W * 0.2, W * 0.8);
        launchRocket(x);
      }, i * 150);
    }
  }
  
  requestAnimationFrame(detectBeatAndFireworks);
}


detectBeatAndFireworks();
</script>
</body>
</html>
